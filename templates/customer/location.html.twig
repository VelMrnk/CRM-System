{% extends 'base.html.twig' %}

{% block body %}
    {% if form %}
    {{ form_start(form, {'attr': {'class': 'form-horizontal jquery-validation'} }) }}
    <div class="panel panel-default">
        <div class="panel-head">
            <h6><i class="icon-location3"></i> {{ 'customer.location.locations'|trans({}, 'labels') }} </h6>
        </div>
        <div class="panel-body address">
            <div {% if form.name.vars.errors|length %} class="form-group has-error" {% else %} class="form-group" {% endif %}>
                {{ form_label(form.name) }}
                <div class="col-md-10 col-sm-9 col-xs-7">
                    {{ form_widget(form.name) }}
                    {% if not form.name.vars.valid %}
                        <label id="{{ form.name.vars.id }}-error" class="validation-error-label" for="{{ form.name.vars.id }}">
                            {{ form.name.vars.errors[0].message }}
                        </label>
                    {% endif %}
                </div>
            </div>
            <div {% if form.street.vars.errors|length %} class="form-group has-error" {% else %} class="form-group" {% endif %}>
                {{ form_label(form.street) }}
                <div class="col-md-10 col-sm-9 col-xs-7">
                    {{ form_widget(form.street) }}
                    {% if not form.street.vars.valid %}
                        <label id="{{ form.street.vars.id }}-error" class="validation-error-label" for="{{ form.street.vars.id }}">
                            {{ form.street.vars.errors[0].message }}
                        </label>
                    {% endif %}
                </div>
            </div>
            <div {% if form.apartment.vars.errors|length %} class="form-group has-error" {% else %} class="form-group" {% endif %}>
                {{ form_label(form.apartment) }}
                <div class="col-md-10 col-sm-9 col-xs-7">
                    {{ form_widget(form.apartment) }}
                    {% if not form.apartment.vars.valid %}
                        <label id="{{ form.apartment.vars.id }}-error" class="validation-error-label" for="{{ form.apartment.vars.id }}">
                            {{ form.apartment.vars.errors[0].message }}
                        </label>
                    {% endif %}
                </div>
            </div>
            <div {% if form.postalCode.vars.errors|length %} class="form-group has-error" {% else %} class="form-group" {% endif %}>
                {{ form_label(form.postalCode) }}
                <div class="col-md-10 col-sm-9 col-xs-7">
                    {{ form_widget(form.postalCode) }}
                    {% if not form.postalCode.vars.valid %}
                        <label id="{{ form.postalCode.vars.id }}-error" class="validation-error-label" for="{{ form.postalCode.vars.id }}">
                            {{ form.postalCode.vars.errors[0].message }}
                        </label>
                    {% endif %}
                </div>
            </div>
            <div {% if form.city.vars.errors|length %} class="form-group has-error" {% else %} class="form-group" {% endif %}>
                {{ form_label(form.city) }}
                <div class="col-md-10 col-sm-9 col-xs-7">
                    {{ form_widget(form.city) }}
                    {% if not form.city.vars.valid %}
                        <label id="{{ form.city.vars.id }}-error" class="validation-error-label" for="{{ form.city.vars.id }}">
                            {{ form.city.vars.errors[0].message }}
                        </label>
                    {% endif %}
                </div>
            </div>
            <div {% if form.region.vars.errors|length %} class="form-group has-error" {% else %} class="form-group" {% endif %}>
                {{ form_label(form.region) }}
                <div class="col-md-10 col-sm-9 col-xs-7">
                    {{ form_widget(form.region) }}
                    {% if not form.region.vars.valid %}
                        <label id="{{ form.region.vars.id }}-error" class="validation-error-label" for="{{ form.region.vars.id }}">
                            {{ form.region.vars.errors[0].message }}
                        </label>
                    {% endif %}
                </div>
            </div>
            <div {% if form.description.vars.errors|length %} class="form-group has-error" {% else %} class="form-group" {% endif %}>
                {{ form_label(form.description) }}
                <div class="col-md-10 col-sm-9 col-xs-7">
                    {{ form_widget(form.description) }}
                    {% if not form.description.vars.valid %}
                        <label id="{{ form.description.vars.id }}-error" class="validation-error-label" for="{{ form.description.vars.id }}">
                            {{ form.description.vars.errors[0].message }}
                        </label>
                    {% endif %}
                </div>
            </div>
            <div {% if form.workdays.vars.errors|length %} class="form-group has-error" {% else %} class="form-group" {% endif %}>
                {% set workdays = {'workdays': form.workdays} %}
                {% include 'customer/forms/workdays.html.twig' with workdays %}
            </div>
            <div class="form-actions text-right">
                <button type="submit" class="btn btn-action" onclick="validate(this)">{{ 'button.add'|trans({}, 'labels') }}</button>
            </div>
        </div>
    </div>
    {{ form_end(form) }}
    {% endif %}

    {% if forms|length %}
        {%  for key, form in forms %}
        <div class="panel panel-default {% if key is not divisible by (2) %} row-style {% endif %}">
            {{ form_start(form, {'attr': {
                'action': path('ajax_member_location_update', {id: form.vars.value.id}),
                'class': 'form-horizontal ajaxUpdate jquery-validation'}
            }) }}
            <div class="panel-body address">
                <div class="form-group">
                    {{ form_label(form.name) }}
                    <div class="col-md-10 col-sm-9 col-xs-7">
                        {{ form_widget(form.name) }}
                    </div>
                </div>
                {% if not form.vars.value.isDelivery %}
                    <div class="form-group">
                        {{ form_label(form.street) }}
                        <div class="col-md-10 col-sm-9 col-xs-7">
                            {{ form_widget(form.street) }}
                        </div>
                    </div>
                    <div class="form-group">
                        {{ form_label(form.apartment) }}
                        <div class="col-md-10 col-sm-9 col-xs-7">
                            {{ form_widget(form.apartment) }}
                        </div>
                    </div>
                    <div class="form-group">
                        {{ form_label(form.postalCode) }}
                        <div class="col-md-10 col-sm-9 col-xs-7">
                            {{ form_widget(form.postalCode) }}
                        </div>
                    </div>
                    <div class="form-group">
                        {{ form_label(form.city) }}
                        <div class="col-md-10 col-sm-9 col-xs-7">
                            {{ form_widget(form.city) }}
                        </div>
                    </div>
                    <div class="form-group">
                        {{ form_label(form.region) }}
                        <div class="col-md-10 col-sm-9 col-xs-7">
                            {{ form_widget(form.region) }}
                        </div>
                    </div>
                {% endif %}
                <div class="form-group">
                    {{ form_label(form.description) }}
                    <div class="col-md-10 col-sm-9 col-xs-7">
                        {{ form_widget(form.description) }}
                    </div>
                </div>
                <div class="form-group">
                    {% set workdays = {'workdays': form.workdays} %}
                    {% include 'customer/forms/workdays.html.twig' with workdays %}
                </div>
                <div class="form-group">
                    {{ form_label(form.isActive) }}
                    <div class="col-md-10 col-sm-9 col-xs-7">
                        <div class="checkbox checkbox-switchery table-switch">
                            {{ form_widget(form.isActive) }}
                            {{ form_errors(form.isActive) }}
                        </div>
                    </div>
                </div>
                <div class="form-actions text-right">
                    <span id="form-status">
                        <button type="button" class="btn btn-icon btn-success btn-save">
                            {{ 'button.save'|trans({}, 'labels') }}
                        </button>
                    </span>

                    {% if not form.vars.value.isDelivery %}
                        {% if form.vars.value.shares|length == 0 %}
                            <button type="button"
                                    data-path="{{ path('ajax_location_delete', {id: form.vars.value.id}) }}"
                                    data-toggle="modal" href="#small_modal" class="btn btn-danger btn-icon btn-delete">
                                <i class="icon-trash"></i>
                            </button>
                        {% else %}
                            <span class="tip" data-placement="top" title="{{ 'customer.location.denied_remove'|trans({}, 'labels') }}">
                                <button type="button" class="btn btn-danger btn-icon disabled"> <i class="icon-trash"></i></button>
                            </span>
                        {% endif %}
                    {% endif %}
                </div>
            </div>
            {{ form_end(form) }}
        </div>
        {% endfor %}

        {{ include ("modal/delete-modal.html.twig") }}
    {% endif %}
{% endblock body %}

{% block scripts %}
    <script src="{{ asset('js/plugins/ui/moment/moment.min.js') }}"></script>
    <script src="{{ asset('js/plugins/ui/moment/moment_timezone.js') }}"></script>

    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAFudPQ3bgPztQLPBngp9B425BBl9q5Duo&libraries=places"></script>
    <script src="{{ asset('js/plugins/googleMapsSearch.js') }}"></script>
    <script>
        var $addressFields = $('input[name$="street]"]');

        if ($addressFields[0]) {
            // Enable google address search autocomplete
            var country = '{{ app.user.client.country }}'.length > 0 ? '{{ app.user.client.country }}' : null;
            initAutocomplete($addressFields, country);
        }
    </script>
    <script>
        /**
         * Get datetime object from start time (in hours) and duration (in hours)
         * Change endTime field and label of field
         */
        $('select[id$="_startTime"], input[id$="_duration"]').on('keyup change', function () {
            var $this = $(this),
                $parent = $this.closest('.row'),
                $startTime = $parent.find('select[id$="_startTime"]'),
                $duration = $parent.find('input[id$="_duration"]'),
                $endTime = $parent.find('input[id$="_endTime"]');

            // If fields is filled, calculate end time in needed format and set the field. Else, set default values
            if ($startTime.val().length > 0 && $duration.val().length > 0) {
                var endTime = getEndTime($startTime.val(), $duration.val());
                $endTime.val(endTime.format('hh:mm A'));
            } else {
                $endTime.val('');
            }
        });


        // Create datetime object from date and given time and add duration to the time
        function getEndTime(startTime, duration) {
            var fullDate = new Date(),
                d = moment(fullDate).format('L'),
                date = moment(d + ' ' + startTime);

            return date.add(duration, 'hours');
        }

        // Add number validation. Min - 1, Max - 23
        $('input[id$="_duration"]').on('mouseup keyup', function () {
            var $this = $(this);

            if ($this.val().length > 0) {
                if ($this.val() > 0) {
                    $this.val(Math.min(23, Math.max(1, $(this).val())));
                    $this.trigger('change');
                } else {
                    $this.val(0);
                }
            }
        });


        // Show/hide work time fields (Start time, duration, end time) if work day selected/unselected
        $('input[id$="_isActive"]').on('change', function () {
            // Get work time fields
            var $this = $(this),
                $parentRow = $this.closest('.row'),
                $workTime = $parentRow.find('div[id^="worktime_"]');

            if ($this.is(':checked')) {
                $workTime.removeClass('hidden');
            } else {
                $parentRow.find('input').val('');
                $parentRow.find('select').val('').trigger('change');
                $workTime.addClass('hidden');
            }
        });
    </script>
{% endblock %}